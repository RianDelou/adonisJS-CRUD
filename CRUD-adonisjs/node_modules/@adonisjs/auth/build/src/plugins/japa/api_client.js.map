{"version":3,"sources":["../../../../src/plugins/japa/api_client.ts"],"sourcesContent":["/*\n * @adonisjs/auth\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\n/// <reference types=\"@adonisjs/session/plugins/api_client\" />\n\nimport type { PluginFn } from '@japa/runner/types'\nimport { ApiClient, ApiRequest } from '@japa/api-client'\nimport type { ApplicationService } from '@adonisjs/core/types'\n\nimport debug from '../../debug.js'\nimport type { Authenticators, GuardContract, GuardFactory } from '../../types.js'\n\ndeclare module '@japa/api-client' {\n  export interface ApiRequest {\n    authData: {\n      guard: keyof Authenticators | '__default__'\n      args: [unknown, ...any[]]\n    }\n\n    /**\n     * Login a user using the default authentication guard\n     * when making an API call\n     */\n    loginAs(\n      ...args: {\n        [K in keyof Authenticators]: Authenticators[K] extends GuardFactory\n          ? ReturnType<Authenticators[K]> extends GuardContract<unknown>\n            ? Parameters<ReturnType<Authenticators[K]>['authenticateAsClient']>\n            : never\n          : never\n      }[keyof Authenticators]\n    ): this\n\n    /**\n     * Define the authentication guard for login\n     */\n    withGuard<K extends keyof Authenticators, Self extends ApiRequest>(\n      this: Self,\n      guard: K\n    ): {\n      /**\n       * Login a user using a specific auth guard\n       */\n      loginAs(\n        ...args: ReturnType<Authenticators[K]> extends GuardContract<any>\n          ? Parameters<ReturnType<Authenticators[K]>['authenticateAsClient']>\n          : never\n      ): Self\n    }\n  }\n}\n\n/**\n * Auth API client to authenticate users when making\n * HTTP requests using the Japa API client\n */\nexport const authApiClient = (app: ApplicationService) => {\n  const pluginFn: PluginFn = function () {\n    debug('installing auth api client plugin')\n\n    /**\n     * Login a user using the default authentication guard\n     * when making an API call\n     */\n    ApiRequest.macro('loginAs', function (this: ApiRequest, user, ...args: any[]) {\n      this.authData = {\n        guard: '__default__',\n        args: [user, ...args],\n      }\n      return this\n    })\n\n    /**\n     * Define the authentication guard for login\n     */\n    ApiRequest.macro('withGuard', function <\n      K extends keyof Authenticators,\n      Self extends ApiRequest,\n    >(this: Self, guard: K) {\n      return {\n        loginAs: (...args) => {\n          this.authData = {\n            guard,\n            args: args,\n          }\n          return this\n        },\n      }\n    })\n\n    /**\n     * Hook into the request and login the user\n     */\n    ApiClient.setup(async (request) => {\n      const auth = await app.container.make('auth.manager')\n      const authData = request['authData']\n      if (!authData) {\n        return\n      }\n\n      const client = auth.createAuthenticatorClient()\n      const guard = authData.guard === '__default__' ? client.use() : client.use(authData.guard)\n      const requestData = await (guard as GuardContract<unknown>).authenticateAsClient(\n        ...authData.args\n      )\n\n      /* c8 ignore next 13 */\n      if (requestData.headers) {\n        debug('defining headers with api client request %O', requestData.headers)\n        request.headers(requestData.headers)\n      }\n      if (requestData.session) {\n        debug('defining session with api client request %O', requestData.session)\n        request.withSession(requestData.session)\n      }\n      if (requestData.cookies) {\n        debug('defining session with api client request %O', requestData.session)\n        request.cookies(requestData.cookies)\n      }\n    })\n  }\n\n  return pluginFn\n}\n"],"mappings":";;;;;;AAYA,SAAS,WAAW,kBAAkB;AAkD/B,IAAM,gBAAgB,CAAC,QAA4B;AACxD,QAAM,WAAqB,WAAY;AACrC,kBAAM,mCAAmC;AAMzC,eAAW,MAAM,WAAW,SAA4B,SAAS,MAAa;AAC5E,WAAK,WAAW;AAAA,QACd,OAAO;AAAA,QACP,MAAM,CAAC,MAAM,GAAG,IAAI;AAAA,MACtB;AACA,aAAO;AAAA,IACT,CAAC;AAKD,eAAW,MAAM,aAAa,SAGhB,OAAU;AACtB,aAAO;AAAA,QACL,SAAS,IAAI,SAAS;AACpB,eAAK,WAAW;AAAA,YACd;AAAA,YACA;AAAA,UACF;AACA,iBAAO;AAAA,QACT;AAAA,MACF;AAAA,IACF,CAAC;AAKD,cAAU,MAAM,OAAO,YAAY;AACjC,YAAM,OAAO,MAAM,IAAI,UAAU,KAAK,cAAc;AACpD,YAAM,WAAW,QAAQ,UAAU;AACnC,UAAI,CAAC,UAAU;AACb;AAAA,MACF;AAEA,YAAM,SAAS,KAAK,0BAA0B;AAC9C,YAAM,QAAQ,SAAS,UAAU,gBAAgB,OAAO,IAAI,IAAI,OAAO,IAAI,SAAS,KAAK;AACzF,YAAM,cAAc,MAAO,MAAiC;AAAA,QAC1D,GAAG,SAAS;AAAA,MACd;AAGA,UAAI,YAAY,SAAS;AACvB,sBAAM,+CAA+C,YAAY,OAAO;AACxE,gBAAQ,QAAQ,YAAY,OAAO;AAAA,MACrC;AACA,UAAI,YAAY,SAAS;AACvB,sBAAM,+CAA+C,YAAY,OAAO;AACxE,gBAAQ,YAAY,YAAY,OAAO;AAAA,MACzC;AACA,UAAI,YAAY,SAAS;AACvB,sBAAM,+CAA+C,YAAY,OAAO;AACxE,gBAAQ,QAAQ,YAAY,OAAO;AAAA,MACrC;AAAA,IACF,CAAC;AAAA,EACH;AAEA,SAAO;AACT;","names":[]}