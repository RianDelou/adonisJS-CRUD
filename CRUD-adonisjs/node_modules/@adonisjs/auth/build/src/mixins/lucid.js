import {
  E_INVALID_CREDENTIALS
} from "../../chunk-UGHJLKDI.js";
import {
  __decorateClass
} from "../../chunk-CZCFTIBB.js";

// src/mixins/lucid.ts
import { RuntimeException } from "@adonisjs/core/exceptions";
import { beforeSave } from "@adonisjs/lucid/orm";
function withAuthFinder(hash, options) {
  return (superclass) => {
    class UserWithUserFinder extends superclass {
      static async hashPassword(user) {
        if (user.$dirty[options.passwordColumnName]) {
          ;
          user[options.passwordColumnName] = await hash().make(
            user[options.passwordColumnName]
          );
        }
      }
      /**
       * Finds the user for authentication via "verifyCredentials".
       * Feel free to override this method customize the user
       * lookup behavior.
       */
      static findForAuth(uids, value) {
        const query = this.query();
        uids.forEach((uid) => query.orWhere(uid, value));
        return query.limit(1).first();
      }
      /**
       * Find a user by uid and verify their password. This method is
       * safe from timing attacks.
       */
      static async verifyCredentials(uid, password) {
        if (!uid || !password) {
          throw new E_INVALID_CREDENTIALS("Invalid user credentials");
        }
        const user = await this.findForAuth(options.uids, uid);
        if (!user) {
          await hash().make(password);
          throw new E_INVALID_CREDENTIALS("Invalid user credentials");
        }
        const passwordHash = user[options.passwordColumnName];
        if (!passwordHash) {
          throw new RuntimeException(
            `Cannot verify password during login. The value of column "${options.passwordColumnName}" is undefined or null`
          );
        }
        if (await hash().verify(passwordHash, password)) {
          return user;
        }
        throw new E_INVALID_CREDENTIALS("Invalid user credentials");
      }
    }
    __decorateClass([
      beforeSave()
    ], UserWithUserFinder, "hashPassword", 1);
    return UserWithUserFinder;
  };
}
export {
  withAuthFinder
};
//# sourceMappingURL=lucid.js.map